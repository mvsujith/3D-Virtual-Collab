<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Three.js Proximity Detection & Popup Example</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: Arial, sans-serif;
      }

      canvas {
        display: block;
      }

      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        font-size: 14px;
        max-width: 300px;
      }

      #controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
      }

      /* Popup Styles */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .popup-overlay.visible {
        display: flex;
      }

      .popup-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        animation: popupEnter 0.3s ease-out;
      }

      @keyframes popupEnter {
        from {
          transform: translateY(30px) scale(0.9);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .popup-header {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .popup-title {
        font-size: 24px;
        font-weight: 600;
        color: #212529;
        margin: 0;
      }

      .popup-close {
        background: none;
        border: none;
        font-size: 28px;
        color: #6c757d;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .popup-close:hover {
        background-color: #e9ecef;
        color: #495057;
      }

      .popup-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .discovery-content {
        text-align: center;
      }

      .discovery-title {
        font-size: 28px;
        color: #007bff;
        margin: 0 0 20px 0;
      }

      .discovery-subtitle {
        font-size: 18px;
        color: #6c757d;
        margin: 0 0 30px 0;
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .feature-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border: 2px solid #e9ecef;
        transition: border-color 0.2s;
      }

      .feature-card:hover {
        border-color: #007bff;
      }

      .feature-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .feature-title {
        font-size: 16px;
        font-weight: 600;
        color: #212529;
        margin: 0 0 10px 0;
      }

      .feature-desc {
        font-size: 14px;
        color: #6c757d;
        margin: 0;
      }

      .cta-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 20px;
      }

      .cta-button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div id="info">
      <div><strong>üéØ Proximity Detection Demo</strong></div>
      <div id="distance">Distance: --</div>
      <div id="status">Status: --</div>
      <div style="margin-top: 10px; font-size: 12px">
        Walk the soldier near the Tokyo model to trigger the popup!
      </div>
    </div>

    <div id="controls">
      <div><strong>Controls:</strong></div>
      <div>WASD - Move soldier</div>
      <div>Mouse - Camera control</div>
      <div>Trigger Distance: 15 units</div>
    </div>

    <!-- Popup Overlay -->
    <div id="popupOverlay" class="popup-overlay">
      <div class="popup-container">
        <div class="popup-header">
          <h2 class="popup-title">üèôÔ∏è Welcome to LittlestTokyo!</h2>
          <button class="popup-close" onclick="closePopup()">√ó</button>
        </div>
        <div class="popup-body">
          <div class="discovery-content">
            <h3 class="discovery-title">Discover Amazing Projects</h3>
            <p class="discovery-subtitle">
              You've discovered a hub of innovation and creativity
            </p>

            <div class="features-grid">
              <div class="feature-card">
                <div class="feature-icon">üöÄ</div>
                <h4 class="feature-title">Innovation Hub</h4>
                <p class="feature-desc">Connect with innovators worldwide</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">üéØ</div>
                <h4 class="feature-title">Project Discovery</h4>
                <p class="feature-desc">Find projects that match your skills</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">ü§ù</div>
                <h4 class="feature-title">Collaboration</h4>
                <p class="feature-desc">Work together on exciting ventures</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">üí°</div>
                <h4 class="feature-title">Ideas Exchange</h4>
                <p class="feature-desc">Share and develop new concepts</p>
              </div>
            </div>

            <button
              class="cta-button"
              onclick="alert('Welcome to the platform!')"
            >
              Start Exploring
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      // Scene setup
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      const renderer = new THREE.WebGLRenderer({ antialias: true });

      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      document.body.appendChild(renderer.domElement);

      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 5, 5);
      directionalLight.castShadow = true;
      scene.add(directionalLight);

      // Ground plane
      const groundGeometry = new THREE.PlaneGeometry(100, 100);
      const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
      const ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Camera controls
      const controls = new OrbitControls(camera, renderer.domElement);
      camera.position.set(10, 10, 10);
      controls.target.set(0, 0, 0);
      controls.update();

      // Models
      let soldierModel = null;
      let tokyoModel = null;
      let mixer = null;
      let soldierMixer = null;
      let clock = new THREE.Clock();

      // Proximity detection variables
      const TRIGGER_DISTANCE = 15;
      const TOKYO_POSITION = new THREE.Vector3(20, 0, 20);
      let popupShown = false;

      // Keyboard controls
      const keys = {
        w: false,
        a: false,
        s: false,
        d: false,
      };

      // UI elements
      const distanceElement = document.getElementById("distance");
      const statusElement = document.getElementById("status");
      const popupOverlay = document.getElementById("popupOverlay");

      // Load Tokyo model
      const loader = new GLTFLoader();
      loader.load("/littlest_tokyo.glb", function (gltf) {
        tokyoModel = gltf.scene;
        tokyoModel.position.copy(TOKYO_POSITION);
        tokyoModel.scale.setScalar(0.1);
        scene.add(tokyoModel);

        // Setup Tokyo animations
        if (gltf.animations && gltf.animations.length > 0) {
          mixer = new THREE.AnimationMixer(tokyoModel);
          gltf.animations.forEach((clip) => {
            const action = mixer.clipAction(clip);
            action.timeScale = 0.3; // Slow animation
            action.play();
          });
        }

        console.log("‚úÖ Tokyo model loaded");
      });

      // Load Soldier model
      loader.load("/Soldier.glb", function (gltf) {
        soldierModel = gltf.scene;
        soldierModel.position.set(0, 0, 0);
        soldierModel.scale.setScalar(1);
        scene.add(soldierModel);

        // Setup soldier animations
        if (gltf.animations && gltf.animations.length > 0) {
          soldierMixer = new THREE.AnimationMixer(soldierModel);

          // Find walk animation
          const walkClip = gltf.animations.find(
            (clip) =>
              clip.name.toLowerCase().includes("walk") ||
              clip.name.toLowerCase().includes("run")
          );

          if (walkClip) {
            const walkAction = soldierMixer.clipAction(walkClip);
            walkAction.play();
          }
        }

        soldierModel.traverse((child) => {
          if (child.isMesh) {
            child.castShadow = true;
          }
        });

        console.log("‚úÖ Soldier model loaded");
      });

      // Keyboard event listeners
      document.addEventListener("keydown", (e) => {
        const key = e.key.toLowerCase();
        if (keys.hasOwnProperty(key)) {
          keys[key] = true;
        }
      });

      document.addEventListener("keyup", (e) => {
        const key = e.key.toLowerCase();
        if (keys.hasOwnProperty(key)) {
          keys[key] = false;
        }
      });

      // Popup functions
      window.closePopup = function () {
        popupOverlay.classList.remove("visible");
        popupShown = false;
      };

      function openPopup() {
        if (!popupShown) {
          popupOverlay.classList.add("visible");
          popupShown = true;
          console.log("üéâ Popup opened due to proximity!");
        }
      }

      // Handle escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && popupShown) {
          closePopup();
        }
      });

      // Movement and proximity detection
      function updateSoldier(delta) {
        if (!soldierModel) return;

        const speed = 10;
        const moveVector = new THREE.Vector3();

        // Calculate movement based on keys
        if (keys.w) moveVector.z -= 1;
        if (keys.s) moveVector.z += 1;
        if (keys.a) moveVector.x -= 1;
        if (keys.d) moveVector.x += 1;

        // Normalize and apply movement
        if (moveVector.length() > 0) {
          moveVector.normalize();
          moveVector.multiplyScalar(speed * delta);
          soldierModel.position.add(moveVector);

          // Face movement direction
          const targetRotation = Math.atan2(moveVector.x, moveVector.z);
          soldierModel.rotation.y = targetRotation;
        }

        // Proximity detection
        if (tokyoModel) {
          const distance = soldierModel.position.distanceTo(TOKYO_POSITION);
          distanceElement.textContent = `Distance: ${distance.toFixed(
            1
          )} units`;

          if (distance <= TRIGGER_DISTANCE) {
            statusElement.textContent = "Status: üéØ IN PROXIMITY ZONE!";
            statusElement.style.color = "#00ff00";

            // Trigger popup
            if (!popupShown) {
              openPopup();
            }
          } else {
            statusElement.textContent = "Status: Moving...";
            statusElement.style.color = "#ffffff";
          }
        }
      }

      // Animation loop
      function animate() {
        requestAnimationFrame(animate);

        const delta = clock.getDelta();

        // Update models
        updateSoldier(delta);

        // Update mixers
        if (mixer) mixer.update(delta);
        if (soldierMixer) soldierMixer.update(delta);

        // Update camera to follow soldier
        if (soldierModel) {
          const offset = new THREE.Vector3(10, 10, 10);
          const targetPosition = soldierModel.position.clone().add(offset);
          camera.position.lerp(targetPosition, 0.02);
          controls.target.copy(soldierModel.position);
        }

        controls.update();
        renderer.render(scene, camera);
      }

      // Handle window resize
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Start animation loop
      animate();

      console.log(`
üéÆ Proximity Detection Demo
- Use WASD to move the soldier
- Walk near the Tokyo model (distance < ${TRIGGER_DISTANCE} units)
- A popup will appear when you get close!
- Press Escape or click X to close the popup
        `);
    </script>
  </body>
</html>
